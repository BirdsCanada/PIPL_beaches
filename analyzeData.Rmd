---
title: "analyzeData"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(optimx)
library(DHARMa)

mod_human<-read.csv(file = '../Data/temporalMod.csv') %>% 
  select(-1)
mod_phys<-read.csv(file = '../Data/spatialMod.csv') %>% 
  select(-1)
```

## Stats Plan Ideas/Notes

Model with all beaches data (CWS prod data and physical data)
-maybe use a category of always has pipls, never has pipls, sometimes has pipls
- prod_var ~ Length_km + beachArea + urban_percent + agr_percent + road_percent + beach_forage + *beach width(?)* + (1|Year) + (1|BeachID) ?????
- this model would cover physical characteristics only
- look into how we can do effect size, could drop factors and look at variation explained and it's change (sensu Sarah paper)
- serious con of not being able to compare effect size of diff types within a model
- probably over-paramaterized

Human survey data
- could model based on categorical productivity variable to assess what's important
- could just summarize and put into a more generic model (base off BRC)
- If I model this it could help direct the BRC, what should we rate
- nested model BeachID/Year, can have specific human summary variables per beach per year

Overall model
- Should I try to do one big model??
- split into types of factors? human, physical, environmental? One model each?



## Models

### Spatial Models
```{r poisson regression}
hist(mod_phys$max_BP)
mean(mod_phys$max_BP, na.rm = TRUE) #1.559
var(mod_phys$max_BP, na.rm = TRUE) #3.044

m1<-glm(max_BP ~ BeachArea_km + beach_width + Length_km + parkArea + bufferPop_km2 + Border_road + tot_area_km_Beach + developedLand + Management + Region, data = mod_phys, family = poisson(link = "log")) # no error

m2<-glm(max_BP ~ BeachArea_km + beach_width + Length_km + parkArea + bufferPop_km2 + Border_road + tot_area_km_Beach + developedLand  + Region, data = mod_phys, family = poisson(link = "log")) # no error

summary(m1)
summary(m2) #better AIC and I'm not happy with management and it's designations right now
```

all good
```{r model validation}
# with DHARMa

simOutput <- simulateResiduals(fittedModel = m2, plot = T)
#some QQ plot deviation but n.s. I'm okay with this model (DHARMa documentation)

#tested zero inflation because we have a lot of 0 presence observations
testZeroInflation(simOutput) #this is okay, n.s. and well within the distribution

#overdispersion is a common issue with poisson
testDispersion(simOutput, type = "PearsonChisq") #okay

```


```{r spatial model effect size}
sjPlot::plot_model(m2, show.values = TRUE, axis.lim = c(.001,1000), sort.est = TRUE, value.offset = .3)

#these are worth discussing!
ggplot(mod_phys, aes(tot_area_km_Beach, developedLand, color = Region)) + geom_point() + geom_smooth(method = "lm")
ggplot(mod_phys, aes(tot_area_km_Beach, bufferPop_km2, color = Region)) + geom_point() + geom_smooth(method = "lm")

ggplot(mod_phys, aes(Length_km, max_BP, color = beach_width))+ geom_point() +scale_color_gradient(low="red", high="yellow")
```


Productivity models
```{r productivity models}
hist(mod_phys$avg_productivity)
mean(mod_phys$avg_productivity, na.rm = TRUE) #1.555
var(mod_phys$avg_productivity, na.rm = TRUE) #1.550

hist(log10(mod_phys$avg_productivity))

mod.data.p<-mod_phys #%>% 
  #filter(avg_productivity>0)

#can't use poisson distributions because they're non-integer values
mp1<-lm(avg_productivity ~ BeachArea_km + beach_width + Length_km + parkArea + bufferPop_km2 + Border_road + tot_area_km_Beach + developedLand + Management + Region, data = mod.data.p)

mp2<-lm(avg_productivity ~ BeachArea_km + beach_width + Length_km + parkArea + bufferPop_km2 + Border_road + tot_area_km_Beach + developedLand + Region, data = mod.data.p)

summary(mp1)
summary(mp2)

AIC(mp1,mp2) #mp2 AIC = 196.6, mp1 AIC = 201.7

```

issues with model validation :(
```{r model validation prod}
simOutput <- simulateResiduals(fittedModel = mp2, plot = T)#okay

#tested zero inflation because we have a lot of 0 presence observations
testZeroInflation(simOutput) #problem

#overdispersion is a common issue with poisson
testDispersion(simOutput, type = "PearsonChisq", alternative = "greater") #n.s.
```


```{r spatial model effect size}
sjPlot::plot_model(mp2, show.values = TRUE, sort.est = TRUE, value.offset = .3)

```


### Human Model

fitted following Zuur (2009) methods for validation

This model is A-OKAY
```{r logistic regression}
mod.data<-mod_human %>% 
  select(BeachID:Year, signs_small:vehicles, dogs_unleashedTotal:dogs_all, peopleIntensity, County, breedingSuccess) %>% 
  na.omit()

mb1<-glmer(breedingSuccess ~ signs_small + signs_large + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = binomial, control = glmerControl(optimizer = "bobyqa"))
#allFit(mb1) #bobyqa

summary(mb1)
```


```{r model validations}
simOutput <- simulateResiduals(fittedModel = mb1, plot = T) #some quantile abnormality but n.s.

testDispersion(mb1, type = "PearsonChisq", alternative = "greater") #okay, only looked for overdispersion
testZeroInflation(mb1) #okay


#for the variables
plotResiduals(simOutput, form = mod.data$signs_small)
plotResiduals(simOutput, form = mod.data$signs_large)
plotResiduals(simOutput, form = mod.data$peopleIntensity)
plotResiduals(simOutput, form = mod.data$fencedNests)
plotResiduals(simOutput, form = mod.data$dogs_all) #issues but n.s.
plotResiduals(simOutput, form = mod.data$dogs_unleashedTotal)
plotResiduals(simOutput, form = mod.data$BeachID) #n.s. okay
plotResiduals(simOutput, form = mod.data$County) #one group, sig

#model okay
```


```{r plotting effect}
sjPlot::plot_model(mb1, show.values = TRUE, sort.est = TRUE, value.offset = .3)


```


Productivity model
```{r productivity human model}
mod.data.f<-mod_human %>% 
  select(BeachID:Year, signs_small:vehicles, dogs_unleashedTotal:dogs_all, peopleIntensity, County, Productivity) %>% 
  mutate(fledglingSuccess = ifelse(Productivity >1.65, 1, 0)) %>% 
  na.omit()

mf1<-glmer(fledglingSuccess ~ signs_small + signs_large + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = binomial, control = glmerControl(optimizer = "Nelder_Mead"))
#allFit(mf1) #Nelder_Mead

summary(mf1)
```

model okay
```{r fledgling validation}
simOutput <- simulateResiduals(fittedModel = mf1, plot = T) #some quantile abnormality but n.s.

testDispersion(mb1, type = "PearsonChisq", alternative = "greater") #okay
testZeroInflation(mb1) #okay
```


```{r effect size plot}
sjPlot::plot_model(mf1, show.values = TRUE, sort.est = TRUE, value.offset = .3)

fig.data<-mod_human %>% 
  mutate(fledglingSuccess = ifelse(Productivity >1.65, 1, 0)) %>% 
  mutate(fencePres = ifelse(fencedNests >0, "Yes", "No")) %>% 
  na.omit()
fig.data<-left_join(fig.data, mod_phys[,c(1:2)], by = "BeachID")
fig.data$pred.fledg <- predict(mf1, newdata=fig.data, type="response")

ggplot(fig.data, aes(signs_large, YE_pairs, color = as.factor(fledglingSuccess), group = fledglingSuccess))+geom_point() + geom_smooth(method = "lm")

ggplot(fig.data, aes(signs_large, fencedNests, color = as.factor(fledglingSuccess), group = fledglingSuccess))+geom_point() + geom_smooth(method = "lm")

### this plot has potential, shows a difference in signs present at unsuccessful sites
ggplot(fig.data, aes(signs_large, pred.fledg, group = fencePres, color = fencePres))+ geom_point() + geom_smooth(method = "lm")

#looked at the effect by region and it was nothing important
ggplot(fig.data, aes(signs_large, fledglingSuccess)) + geom_point(alpha=.5) +
  stat_smooth(method="glm", se=TRUE, method.args = list(family=binomial))

ggplot(fig.data, aes(fencedNests, fledglingSuccess)) + geom_point(alpha=.5) +
  stat_smooth(method="glm", se=TRUE, method.args = list(family=binomial)) 

#rug plots are underwhelming
fig.data<-fig.data %>% 
  mutate(goodFledg = ifelse(fledglingSuccess == 1, fencedNests, NA),
         badFledg  = ifelse(fledglingSuccess == 0, fencedNests, NA)) %>% 
  mutate(goodFledgSign = ifelse(fledglingSuccess == 1, signs_large, NA),
         badFledgSign  = ifelse(fledglingSuccess == 0, signs_large, NA))

ggplot(fig.data, aes(x = fencedNests, y = fledglingSuccess)) +
  stat_smooth(method="glm", se=TRUE, method.args = list(family=binomial)) +
  labs(x = "fencedNests", y = "Fledgling Goal") +
  geom_rug(aes(x = badFledg), sides = "b", alpha = 0.2) +
  geom_rug(aes(x = goodFledg), sides = "t", alpha = 0.2)

ggplot(fig.data, aes(x = signs_large, y = fledglingSuccess)) +
  stat_smooth(method="glm", se=TRUE, method.args = list(family=binomial)) +
  labs(x = "fencedNests", y = "Fledgling Goal") +
  geom_rug(aes(x = badFledgSign), sides = "b", alpha = 0.2) +
  geom_rug(aes(x = goodFledgSign), sides = "t", alpha = 0.2)
```

### Figures

```{r table}
beachTable<-data.frame(mod_phys$BeachID) %>% 
  rename(Beach = mod_phys.BeachID)
beachTable$SpatialModel<-"x"
beachTable$TemporalModel<-ifelse(beachTable$Beach %in% mod_human$BeachID, "x", "")
beachTable$Region<-mod_phys$Region
beachTable<-left_join(beachTable, mod_human[,c(1,23)], by = c("Beach"="BeachID")) %>% 
  unique() %>% 
  mutate(County = replace(County, Beach == "James", "Pictou")) %>% 
  mutate(County = replace(County, Beach == "Bowen Island", "Pictou")) %>% 
  mutate(County = replace(County, Beach == "Stoney (Lawrencetown Head)", "Halifax")) %>% 
  mutate(County = replace(County, Beach == "Cranberry Pond", "Queens")) %>% 
  mutate(County = replace(County, Beach == "Harbour Breeze, Port Joli", "Shelburne")) %>%
  mutate(County = replace(County, Beach == "Dominion (Lingan)", "Cape Breton")) %>% 
  mutate(County = replace(County, Beach == "Ogdens Pond", "Antigonish")) %>% 
  filter(!is.na(County)) %>% 
  arrange(Region, County) %>% 
  select(Region:County, Beach, SpatialModel, TemporalModel)

write.table(beachTable)
```


```{r}
sjPlot::plot_model(mf1, show.values = TRUE, value.offset = .3, ylim = c(0.1,1000))
sjPlot::plot_model(mb1, show.values = TRUE, value.offset = .3)
save_plot(plot_model(mb1, show.values = TRUE, value.offset = .3))
mf1_eff<-get_model_data(mf1, type = "est")
mb1_eff<-get_model_data(mb1, type = "est")
#save and join together in word?
sjPlot::tab_model(mf1)
sjPlot::tab_model(mb1)

f<-ggplot(mf1_eff, aes(estimate, term, color = group)) + geom_vline(aes(xintercept = 1),color = "gray") + geom_point()

f + geom_errorbar(aes(xmin=conf.low, xmax=conf.high), width=.08,position=position_dodge(.9)) + scale_x_continuous(limits = c(.01,100),trans = "log10", breaks = c(0.01,0.1,1,10,100), labels = c(0.01,0.1,1,10,100))  + scale_y_discrete(labels = c("Fenced Nests", "Mean Unleashed Dogs", "Visitor Intensity", "Mean Total Dogs", "Large Signs","Small Signs"))+ labs(x = "Odds Ratio", y = "Model Term") + geom_text(aes(label = p.label), vjust = -1) + theme(legend.position="none")

b<-ggplot(mb1_eff, aes(estimate, term, color = group)) + geom_vline(aes(xintercept = 1),color = "gray") + geom_point()

b + geom_errorbar(aes(xmin=conf.low, xmax=conf.high), width=.08,position=position_dodge(.9)) + scale_x_continuous(limits = c(.1,1000000),trans = "log10", breaks = c(0.01,0.1,1,10,100,1000,10000,100000,1000000), labels = c(0.01,0.1,1,10,100,1000,10000,100000,1000000))  + scale_y_discrete(labels = c("Fenced Nests", "Mean Unleashed Dogs", "Visitor Intensity", "Mean Total Dogs", "Large Signs","Small Signs"))+ labs(x = "Odds Ratio", y = "Model Term") + geom_text(aes(label = p.label), vjust = -1) + theme(legend.position="none")
```



##### old model code
```{r fixing singularity old}
library("numDeriv")
library("reshape2")
library("afex")

mod<-glmer(YE_pairs ~ signs_small + signs_large + vehicles + dogs_all + peopleIntensity + offleash_ind + County + fencedNests + (1|BeachID), data = mod_humanSc, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
summary(mod)

tt <- getME(mod,"theta")
ll <- getME(mod,"lower")
min(tt[ll==0]) #def singular

#checking gradient calculations
derivs1 <- mod_sc@optinfo$derivs
sc_grad1 <- with(derivs1,solve(Hessian,gradient))
max(abs(sc_grad1))

max(pmin(abs(sc_grad1),abs(derivs1$gradient))) #below the tolerance of .001 so this is good!

#more iterations?
ss <- getME(mod_sc,c("theta","fixef"))
mod2 <- update(mod_sc,start=ss,control=glmerControl(optCtrl=list(maxfun=2e4))) #still singular


```


```{r random factor selection old}
#rescale numerical variables
numcols<-which(sapply(mod_human[,1:23], is.numeric)) #don't rescale response variables for the poisson distribution (no negatives)
mod_humanSc<-mod_human
mod_humanSc[,numcols] <- scale(mod_humanSc[,numcols])

mean(mod.data$YE_pairs) #0.853
var(mod.data$YE_pairs) #1.799

mod.data<-mod_humanSc %>% 
  select(BeachID:Year, signs_small:vehicles, dogs_unleashedTotal:dogs_all, peopleIntensity, County) %>% 
  na.omit()
#with scaled variables
#assess random factor structure first
mh1<-glmer(YE_pairs ~ signs_small + signs_large + vehicles + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|Year) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
#no error

mh2<-glmer(YE_pairs ~ signs_small + signs_large + vehicles + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + Year + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
#no error

mh3<-glmer(YE_pairs ~ signs_small + signs_large + vehicles + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|County) + (1|Year) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
#no error

mh4<-glmer(YE_pairs ~ signs_small + signs_large + vehicles + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
# no error

#compare AIC values to pick random structure?
summary(mh1) #637.9
summary(mh2) #633.9
summary(mh3) #631.2
summary(mh4) #629.2 #best value

```


```{r fixed factor selection old}
drop1(mh4, test = "Chi")

mh5<-glmer(YE_pairs ~ signs_small + signs_large + dogs_all + peopleIntensity + dogs_unleashedTotal +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
drop1(mh5, test = "Chi")

mh6<-glmer(YE_pairs ~ signs_small + signs_large + dogs_all + peopleIntensity +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
drop1(mh6, test = "Chi")

mh7<-glmer(YE_pairs ~ signs_small + signs_large + peopleIntensity +  fencedNests + (1|County) + (1|BeachID), data = mod.data, family = poisson(link = "log"), control = glmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
drop1(mh7, test = "Chi")

summary(mh7)


```


```{r model validations old}
simOutput <- simulateResiduals(fittedModel = mh7, plot = T) #bad for uniformity and quantiles

testDispersion(mh7, type = "PearsonChisq") #not okay
testZeroInflation(mh4) #okay

#for the variables
plotResiduals(simOutput, form = mod.data$signs_small)
plotResiduals(simOutput, form = mod.data$signs_large)
plotResiduals(simOutput, form = mod.data$peopleIntensity)
plotResiduals(simOutput, form = mod.data$fencedNests)
plotResiduals(simOutput, form = mod.data$BeachID) #n.s. okay
plotResiduals(simOutput, form = mod.data$County) #also okay n.s. only a few groups non-uniform

```

### End