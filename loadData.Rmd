---
title: "loadData"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(tidyverse)
```

Note: I'm using relative paths as of right now, my file structure includes a folder with the project subdirectory and a Data folder within, my wd is the project subdirectory
Is this the path style I should keep using?

To Do:
get complete beach area, and parking lot area data



Follow-Up Notes:
-loc_id What is this? is it a coordinates or correlates to a beach?
-Not sure what to do about locations joined in some years but separate in others
-2012-2017 BRC I have all Northern NS survey data raw, but only sandwalkers and dog raw for southern (email someone if needed)
-I have no idea what's going on with goose haven, goose (indian) point, and goose and burks point??


```{r load data}
#Here I load in the 2017-2021 BRC data that was downloaded from Nature Counts and saved as a .csv
all_na <- function(x) any(!is.na(x)) #function to remove columns that are all NA

#path goes back a level to enter Data folder and access csv
piplSurveyAll<-read.csv(file = '../Data/dbo_vwAtPiplHeader2021.csv') %>% 
  select_if(all_na) # removes empty columns

#Here I load and clean the productivity data from 2012-2021 surveys
brc1<-read.csv(file = '../Data/Summary of Biological Outcomes 2012-2016.csv') #saved sheet 1 (all years)
brc2<-read.csv(file = '../Data/Productivity_2017-2021_LB_BM.csv') 

#physical data including beach length, area (to be added), and parking lot area (to be added)
beachLength<-read.csv(file = '../Data/beachLength.csv') %>% 
  rename(BeachID = 1, Length_km = 3)

#Note on beach length excel sheet states those names are the standard and so I'll use them as the name list
beachnames<-beachLength$BeachID

#most complete beachnames list with correct spelling
beachnames<-append(beachnames, c("James", "Bowen Island", "Goose and Burks Point", "Goose Haven", "Taylor Head Bay", "Chance Harbour", "Margaree Harbour", "MacKay's Point", "Port Mouton Island", "Jimtown", "Linwood", "South Lakevale (Cribbons)", "Tracadie Big Island / Delorey", "Tracadie West Arm", "Ratcliffe Hills (The Cape)")) #
#James and Bowen Island are sometimes apart, the rest are not present in beachLength but are presumably spelled right

```


```{r clean 2017-2021 survey data}

beaches<-piplSurveyAll %>% 
  filter(statprov_code=="NS") %>% 
  select(name) %>% 
  unique() %$% 
  name

#checking to make sure the province codes are correct
x<-piplSurveyAll %>% 
  filter(name %in% beaches) #did this with beachnames first but had 300 less obs.
y<-piplSurveyAll %>% 
  filter(statprov_code == 'NS') 

setdiff(x,y)  #one extra entry in x, use unique id to find form_id 101563 labelled as MB but NS beach
x<-NULL
y<-NULL
#beaches<-NULL

#fixing the mislabelled data point, form_id 101563 labelled as MB
piplSurveyAll[piplSurveyAll$form_id == 101563, 'statprov_code']<-"NS"

range(piplSurveyAll$year) #includes observations from 1999-2005 exclude for now

#create a smaller df with only NS beaches with columns I may want data from (survey and weather and ids etc)
piplSurvey<-piplSurveyAll %>%
  select(3,15,16:22,24,27:31,32,34:39,43:50,54:86) %>%
  filter(statprov_code == 'NS') %>% 
  filter(year %in% 2017:2021)

```

Have all Northern NS survey data raw, but only sandwalkers and dog raw for southern
Do I want raw data or are the summaries fine?
```{r clean 2012-2016 survey data}

```


Here I load and clean the productivity data from 2012-2021 surveys
```{r clean productivity data}

#fix minor issues with brc1
brc1<-brc1 %>% 
  na_if( y = "N/A") %>%  #change manually inputted N/A to NA values
  mutate_at(vars(3:12), as.numeric) %>% #reassign column types to match for joining
  select(1:5,8:11) #remove pairs monitored and site visits columns as brc2 doesn't have these variables


#reformat brc2 to match brc1, remove or rename columns and fill blanks from excel sheet (beach listed once for every 5 entries)
brc2<-brc2 %>% 
  select(1:6,11:12) %>% 
  rename(BeachID = Beach.Name, YE_singles = Singles, YE_pairs = Pairs, Productivity = Yearly.Productivity, Nesting.attempts = n.ofNesting.Attempts, Nestloss_HD = Nestloss) %>% 
  mutate(BeachID = na_if(x = BeachID, y = "")) %>% #change blanks into NA so the fill function can work
  fill(BeachID) %>% #this works because the spreadsheet was ordered by beach name and then year already
  mutate(County = NA)

#fixing BeachID entries to match

#determine which beaches aren't in beachnames (added to the append command in 'load data' chunk)
setdiff(brc2$BeachID, beachnames) #mostly spelling errors, a few places not named in beachnames
setdiff(brc1$BeachID, beachnames) #this list has more beaches not named elsewhere
                               
#using the lists above I manually assigned the correct spelling from the complete list (beachnames)
brc1$BeachID %<>% 
  gsub("Goose Haven, Port Joli", paste(beachnames[64]), .) %>% 
  gsub("Grahams Cove / Ferry Road", paste(beachnames[24]), .) %>%
  gsub("James Beach", paste(beachnames[61]), .) %>%
  gsub("Durham Lane Beach, Port Joli", paste(beachnames[20]), .)
  
brc2$BeachID %<>%
  gsub("\\*", "", .) %>%   
  gsub("&", "and", .) %>% 
  gsub("'", "", .) %>% #removes small formatting differences, punctuation mismatching
  gsub("Cherry Hill", paste(beachnames[9]), .) %>% 
  gsub("Cape LaHave Island", paste(beachnames[6]), .) %>% 
  gsub("Carters and Wobamkek", paste(beachnames[8]), .) %>%
  gsub("Clam Harbour ", paste(beachnames[10]), .) %>% 
  gsub("Conrads", paste(beachnames[12]), .) %>% 
  gsub("Crescent", paste(beachnames[15]), .) %>% 
  gsub("Crows Neck", paste(beachnames[16]), .) %>% 
  gsub("Daniels Head", paste(beachnames[17]), .) %>% 
  gsub("Durham Lane",paste(beachnames[20]), .) %>% 
  gsub("Grahams Cove", paste(beachnames[24]), .) %>%
  gsub("James Beach and Bowen Island", paste(beachnames[30]), .) %>%
  gsub("North East Point", paste(beachnames[39]), .) %>%
  gsub("Rainbow Haven", paste(beachnames[45]), .) %>%
  gsub("Round Bay and Roseway", paste(beachnames[48]), .) %>%
  gsub("Sandhills PP ", paste(beachnames[49]), .) %>%
  gsub("South Harbour ", paste(beachnames[52]), .)

#manually assigning names that aren't working with gsub
#dominion rows 271-275
brc2[271:275, 'BeachID']<-"Dominion (Lingan)"
#pictou rows 241-245
brc2[241:245, 'BeachID']<-"Pictou Bar Spit (Lighthouse)"
# shipping rows 261-265
brc2[261:265, 'BeachID']<-"Shipping Point"

#final check should be 0, all beaches should have been added to beach names or the spelling fixed
setdiff(brc2$BeachID, beachnames)
setdiff(brc1$BeachID, beachnames)
```


```{r create productivity df}
prodData<-rbind(brc1, brc2) %>% 
  arrange(BeachID, Year) %>% 
  mutate(County = na_if(x = County, y = "")) %>%
  fill(County) #adds County information to data from brc2

#Some sites have County typos (multiple counties attributed to one site)
x<-prodData %>% 
  group_by(BeachID) %>% 
  summarise(count = n_distinct(County)) %>% 
  filter(count>1) %>% 
  select(BeachID) # 21 sites with typos

#choose the county that is written more, most of the typos were just one wrong
y<-prodData %>% 
  count(BeachID, County) %>%
  group_by(BeachID) %>% 
  slice(which.max(n)) %>% 
  select(1:2)

# join the correct county information to the prodData
prodData<-left_join(y, prodData, by = 'BeachID') %>% 
  rename(County = County.x) %>% 
  select(1:2,4:10) #remove old column with typos

x<-NULL
y<-NULL
```

adding beach length (from BRC data) and area (google earth beach polygons)
*will add parking lot size and number information when available*
```{r physical beach data load}
prodData<-left_join(prodData, beachLength, by = 'BeachID')

prodData %>% 
  group_by(BeachID) %>% 
  summarize(nas = sum(is.na(Length_km))) %>% 
  filter(nas > 0) #15 beaches in the productivity sheet without beach length calculated.
```



